<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8" />
		<meta
			name="viewport"
			content="width=device-width, initial-scale=1.0, viewport-fit=cover"
		/>
		<meta name="Description" content="Put your description here." />
		<base href="/" />

		<style>
			html,
			body {
				margin: 0;
				padding: 0;
				font-family: sans-serif;
				background-color: #ededed;
				height: 100%;
				width: 100%;
			}

			body {
				display: flex;
			}
		</style>
		<title>Messenger</title>
	</head>

	<body>
		<demo-app></demo-app>

		<script type="module">
			import '@shoelace-style/shoelace/dist/themes/light.css';
			import { ContextProvider } from '@lit/context';
			import { LitElement, css, html } from 'lit';
			import { AppWebsocket } from '@holochain/client';
			import { sharedStyles } from '@tnesh-stack/elements';
			import { SignalWatcher } from '@tnesh-stack/signals';
			import '@tnesh-stack/elements/dist/elements/display-error.js';
			import {
			  ProfilesClient,
			  ProfilesStore,
			  profilesStoreContext
			} from '@darksoil-studio/profiles-zome';
			import {
			  LinkedDevicesClient,
			  LinkedDevicesStore,
			  linkedDevicesStoreContext
			} from '@darksoil-studio/linked-devices-zome';
			import '@darksoil-studio/profiles-zome/dist/elements/profile-prompt.js';
			import '@shoelace-style/shoelace/dist/components/spinner/spinner.js';

			import '../src/elements/messenger-context.ts';
			import { MessengerStore, MessengerClient } from '../src/index.ts';

			export class DemoApp extends SignalWatcher(LitElement) {

			  constructor() {
			    super();
			    this._loading = true;
			    this._view = { view: 'main' };
			  }

			  async firstUpdated() {
			    this._client = await AppWebsocket.connect();

			    await this.initStores(this._client);

			    this._loading = false;
			    this.requestUpdate();
			  }

			  async initStores(appClient) {
			    const profilesStore = new ProfilesStore(new ProfilesClient(appClient, 'messenger_test'));
			    new ContextProvider(this, profilesStoreContext, profilesStore);
			    const profilesStore = new LinkedDevicesStore(new LinkedDevicesClient(appClient, 'messenger_test'));
			    new ContextProvider(this, profilesStoreContext, profilesStore);

			    this._messengerStore = new MessengerStore(new MessengerClient(appClient, 'messenger_test'));
			  }

			  renderContent() {
			    return html`
			      <messenger-context .store=${this._messengerStore}>
			        <!-- TODO: add here the content of your application -->
			      </messenger-context>
			    `;
			  }

			  render() {
			    if (this._loading)
			      return html`<div
			        class="row"
			        style="flex: 1; height: 100%; align-items: center; justify-content: center;"
			      >
			        <sl-spinner></sl-spinner>
			      </div>`;

			    return html`
			        <div class="fill row" style="width: 100vw; height: 100%;">
			          <profile-prompt style="flex: 1;">
			            ${this.renderContent()}
			          </profile-prompt>
			        </div>
			    `;
			  }

			  static styles = [
			    css`
			      :host {
			        display: flex;
			        flex: 1;
			      }
			    `,
			    sharedStyles,
			  ];
			}

			      customElements.define('demo-app', DemoApp);
		</script>
	</body>
</html>
